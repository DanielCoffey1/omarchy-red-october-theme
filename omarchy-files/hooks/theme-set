#!/bin/bash

# Omarchy hook: Install custom waybar configs and update colors when theme changes
# This hook is called with the snake-cased name of the theme that has just been set.

WALLPAPER="$HOME/.config/omarchy/current/background"
THEME_DIR="$HOME/.config/omarchy/current/theme"

# Install custom waybar configuration
WAYBAR_CONFIG_SOURCE="$THEME_DIR/configs/waybar"
WAYBAR_CONFIG_DEST="$HOME/.config/waybar"

if [ -d "$WAYBAR_CONFIG_SOURCE" ]; then
    # Create waybar config directory if it doesn't exist
    mkdir -p "$WAYBAR_CONFIG_DEST"

    # Copy all waybar config files (config.jsonc, style.css, and any other files)
    cp -r "$WAYBAR_CONFIG_SOURCE"/* "$WAYBAR_CONFIG_DEST/" 2>/dev/null || true
    
    # Ensure specific files are copied if they exist
    if [ -f "$WAYBAR_CONFIG_SOURCE/config.jsonc" ]; then
        cp "$WAYBAR_CONFIG_SOURCE/config.jsonc" "$WAYBAR_CONFIG_DEST/config.jsonc"
    fi

    if [ -f "$WAYBAR_CONFIG_SOURCE/style.css" ]; then
        cp "$WAYBAR_CONFIG_SOURCE/style.css" "$WAYBAR_CONFIG_DEST/style.css"
    fi
fi

# Check if pywal is installed
if ! command -v wal &> /dev/null; then
    # Silently exit if pywal is not installed
    exit 0
fi

# Check if wallpaper exists
if [ ! -f "$WALLPAPER" ]; then
    exit 0
fi

# Generate colors with pywal
# -n: Don't set wallpaper (Omarchy already handles this)
# -q: Quiet mode
wal -i "$WALLPAPER" -n -q 2>/dev/null

# Reload waybar if it's running
if pgrep -x waybar > /dev/null; then
    killall -SIGUSR2 waybar 2>/dev/null
fi
